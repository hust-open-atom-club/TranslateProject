# =============================================
# ğŸ“… å·¥ä½œæµåç§°ï¼šæ£€æŸ¥ PR ä¸­çš„ Markdown æ–‡ä»¶ç¿»è¯‘çŠ¶æ€
# âœ… æ¯å¤© UTC 10:00 è‡ªåŠ¨æ‰«æ + æ”¯æŒæ‰‹åŠ¨è§¦å‘
# âœ… æ£€æŸ¥ sources/**/*.md æ˜¯å¦ status: translating ä¸”è¶…æœŸï¼ˆ30å¤©ï¼‰
# âœ… è¶…æœŸåˆ™é€šè¿‡ curl ç›´æ¥å‘é€é£ä¹¦å¡ç‰‡ï¼ˆæ—  Python ä¾èµ–ï¼‰
# =============================================

name: Check PRs for Modified Markdown Files

on:
  schedule:
    - cron: '0 10 * * *'  # æ¯å¤© UTC 10:00
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  pull-requests: read
  contents: read

jobs:
  check-prs:
    runs-on: ubuntu-latest
    steps:

      # ğŸ§± æ­¥éª¤ 1ï¼šæ£€å‡ºä»£ç 
      - name: ğŸ” Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ğŸ“¦ æ­¥éª¤ 2ï¼šå®‰è£… yqï¼ˆä»…ç”¨äºè§£æ YAMLï¼‰
      - name: ğŸ“¦ Install yq
        run: |
          wget -q https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      # âœ… æ­¥éª¤ 3ï¼šéªŒè¯ yq
      - name: âœ… Verify yq
        run: yq --version

      # ğŸ“‹ æ­¥éª¤ 4ï¼šåˆ—å‡ºæ‰€æœ‰ open PR
      - name: ğŸ“‹ List open pull requests
        id: list_prs
        run: |
          PRS=$(gh api --paginate \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/pulls?state=open&per_page=100" \
            --jq '[.[].number] | join(" ")')
          if [ -z "$PRS" ]; then
            echo "ğŸ“­ æ²¡æœ‰æ‰¾åˆ°ä»»ä½• open PR"
            echo "prs=" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“¬ æ‰¾åˆ°ä»¥ä¸‹ PR: $PRS"
            echo "prs=$PRS" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ğŸ” æ­¥éª¤ 5ï¼šéå†æ¯ä¸ª PRï¼Œæ£€æŸ¥è¶…æœŸæ–‡ä»¶ï¼ˆçº¯ Shell + curlï¼‰
      - name: ğŸ” Process each PR and send Feishu alert via curl
        if: ${{ steps.list_prs.outputs.prs != '' }}
        run: |
          # è®¾ç½®è¶…æœŸé˜ˆå€¼ï¼ˆå•ä½ï¼šå¤©ï¼‰
          TIMEOUT_DAYS=30

          # åˆ›å»ºå®‰å…¨ä¸´æ—¶ç›®å½•
          TEMP_DIR=$(mktemp -d)
          trap 'rm -rf "$TEMP_DIR"' EXIT

          # ğŸ”„ éå†æ‰€æœ‰ PR ç¼–å·
          for pr_number in ${{ steps.list_prs.outputs.prs }}; do
            echo ""
            echo "=== ğŸš€ æ­£åœ¨æ£€æŸ¥ PR #$pr_number ==="

            # ğŸŒ è·å– PR è¯¦ç»†ä¿¡æ¯
            PR_INFO=$(gh api "/repos/${{ github.repository }}/pulls/$pr_number")
            PR_URL=$(echo "$PR_INFO" | jq -r '.html_url // "https://github.com/${{ github.repository }}/pull/'$pr_number'"')
            PR_TITLE=$(echo "$PR_INFO" | jq -r '.title // "æ— æ ‡é¢˜"')
            PR_AUTHOR=$(echo "$PR_INFO" | jq -r '.user.login // "æœªçŸ¥"')
            BASE_REF=$(echo "$PR_INFO" | jq -r '.base.ref // "main"')

            echo "ğŸ“Œ æ ‡é¢˜: $PR_TITLE"
            echo "ğŸ‘¤ ä½œè€…: @$PR_AUTHOR"
            echo "ğŸ¯ ç›®æ ‡åˆ†æ”¯: $BASE_REF"

            # ğŸ§¬ è·å– PR åˆå¹¶é¢„è§ˆ
            git fetch origin "pull/$pr_number/merge:pr_merge_$pr_number" 2>/dev/null || {
              echo "âš ï¸ æ— æ³•è·å– PR åˆå¹¶é¢„è§ˆï¼Œå¯èƒ½å†²çªæˆ–å°šæœªå‡†å¤‡å¥½ã€‚è·³è¿‡æ­¤ PRã€‚"
              echo "------------------------------"
              continue
            }
            git checkout pr_merge_$pr_number

            # ğŸ“„ æ£€æŸ¥æ˜¯å¦ä¿®æ”¹äº† sources/**/*.md
            CHANGED_MD_FILES=$(git diff --name-only "origin/$BASE_REF..HEAD" | grep '^sources/.*\.md$' || true)

            if [ -z "$CHANGED_MD_FILES" ]; then
              echo "âœ… PR #$pr_number æœªä¿®æ”¹ sources/**/*.md æ–‡ä»¶ï¼Œè·³è¿‡æ£€æŸ¥"
              echo "------------------------------"
              continue
            fi

            echo "ğŸ“ PR #$pr_number ä¿®æ”¹äº†ä»¥ä¸‹ Markdown æ–‡ä»¶ï¼š"
            echo "$CHANGED_MD_FILES"

            # ğŸ“– æ”¶é›†è¶…æœŸæ–‡ä»¶ï¼ˆæ„é€ å¡ç‰‡å†…å®¹ï¼‰
            ITEMS=()
            HAS_ERROR=false

            while IFS= read -r file; do
              SAFE_FILE=$(realpath -m "$file" 2>/dev/null)
              if [[ ! "$SAFE_FILE" =~ ^$PWD/ ]]; then
                echo "âš ï¸ è·¯å¾„è¶Šæƒ: $file"
                continue
              fi

              if [ ! -f "$SAFE_FILE" ]; then
                echo "âš ï¸ æ–‡ä»¶ä¸å­˜åœ¨: $file"
                continue
              fi

              # ğŸ§¾ æå– YAML Front Matter
              FRONT_MATTER=$(sed -n '/^---$/,/^---$/{/^---$/!p}' "$SAFE_FILE" 2>/dev/null)
              if [ -z "$FRONT_MATTER" ]; then
                echo "âš ï¸ $file æ²¡æœ‰ YAML Front Matter"
                continue
              fi

              # ğŸ—ƒï¸ åˆ›å»ºä¸´æ—¶ YAML æ–‡ä»¶
              TEMP_YAML="$TEMP_DIR/frontmatter_$$.yaml"
              echo "$FRONT_MATTER" > "$TEMP_YAML"

              # ğŸ¯ æå–å­—æ®µ
              STATUS=$(yq eval '.status // ""' "$TEMP_YAML" 2>/dev/null)
              TRANSLATING_DATE=$(yq eval '.translating_date // ""' "$TEMP_YAML" 2>/dev/null)

              # ğŸ” åªæ£€æŸ¥ status: translating
              if [ "$STATUS" = "translating" ]; then
                if [ -z "$TRANSLATING_DATE" ]; then
                  ITEM=$(printf '{"æ–‡ä»¶":"%s","è¶…æœŸ":"ç¼ºå°‘ translating_date å­—æ®µ","PRé“¾æ¥":"%s","ä½œè€…":"%s"}' \
                    "$(printf '%s' "$file" | sed 's/"/\\"/g')" \
                    "$(printf '%s' "$PR_URL" | sed 's/"/\\"/g')" \
                    "$(printf '%s' "@$PR_AUTHOR" | sed 's/"/\\"/g')")
                  ITEMS+=("$ITEM")
                  HAS_ERROR=true
                  echo "âŒ $file: ç¼ºå°‘ translating_date å­—æ®µ"
                else
                  # ğŸ“… å®¹é”™è§£ææ—¥æœŸ
                  DATE_STR=$(echo "$TRANSLATING_DATE" | sed 's|/|-|g')
                  if ! TRANSLATING_TS=$(date -d "$DATE_STR" +%s 2>/dev/null); then
                    ITEM=$(printf '{"æ–‡ä»¶":"%s","è¶…æœŸ":"æ—¥æœŸæ ¼å¼é”™è¯¯: %s","PRé“¾æ¥":"%s","ä½œè€…":"%s"}' \
                      "$(printf '%s' "$file" | sed 's/"/\\"/g')" \
                      "$(printf '%s' "$TRANSLATING_DATE" | sed 's/"/\\"/g')" \
                      "$(printf '%s' "$PR_URL" | sed 's/"/\\"/g')" \
                      "$(printf '%s' "@$PR_AUTHOR" | sed 's/"/\\"/g')")
                    ITEMS+=("$ITEM")
                    HAS_ERROR=true
                    echo "âŒ $file: translating_date æ ¼å¼é”™è¯¯: '$TRANSLATING_DATE'"
                  else
                    TODAY_TS=$(date +%s)
                    DAY_DIFF=$(( (TODAY_TS - TRANSLATING_TS) / 86400 ))
                    if [ $DAY_DIFF -gt $TIMEOUT_DAYS ]; then
                      EMOJI="ğŸš¨"
                      ITEM=$(printf '{"æ–‡ä»¶":"%s","è¶…æœŸ":"%s %d å¤©å‰ (%s)","PRé“¾æ¥":"%s","ä½œè€…":"%s","_days":%d}' \
                        "$(printf '%s' "$file" | sed 's/"/\\"/g')" \
                        "$EMOJI" \
                        $DAY_DIFF \
                        "$DATE_STR" \
                        "$(printf '%s' "$PR_URL" | sed 's/"/\\"/g')" \
                        "$(printf '%s' "@$PR_AUTHOR" | sed 's/"/\\"/g')" \
                        $DAY_DIFF)
                      ITEMS+=("$ITEM")
                      HAS_ERROR=true
                      echo "ğŸš¨ $file: translating_date è¶…è¿‡ $TIMEOUT_DAYS å¤©ï¼ˆ$DAY_DIFF å¤©å‰ï¼‰"
                    else
                      echo "âœ… $file: translating_date åœ¨ $TIMEOUT_DAYS å¤©å†…ï¼ˆ$DAY_DIFF å¤©å‰ï¼‰"
                    fi
                  fi
                fi
              else
                echo "â„¹ï¸ $file: status ä¸æ˜¯ 'translating'ï¼Œè·³è¿‡æ£€æŸ¥"
              fi

            done <<< "$CHANGED_MD_FILES"

            # ğŸš¨ å¦‚æœæœ‰è¶…æœŸæ–‡ä»¶ï¼Œç”¨ curl å‘é€é£ä¹¦å¡ç‰‡
            if [ "$HAS_ERROR" = true ]; then
              echo "ğŸš¨ æ­¤ PR å­˜åœ¨å…ƒæ•°æ®é—®é¢˜ï¼Œå‡†å¤‡å‘é€é£ä¹¦é€šçŸ¥..."

              # ğŸ§¹ æ’åºï¼ˆæŒ‰ _days å€’åºï¼‰
              if [ ${#ITEMS[@]} -gt 0 ]; then
                SORT_FILE="$TEMP_DIR/sort_$$.txt"
                for item in "${ITEMS[@]}"; do
                  days=$(echo "$item" | sed -n 's/.*"_days":\([0-9]*\).*/\1/p')
                  days=${days:-0}
                  printf '%06d %s\n' $((999999 - days)) "$item"
                done > "$SORT_FILE"

                # æ„é€ å¡ç‰‡ elements
                ELEMENTS="[
                  {
                    \"tag\": \"div\",
                    \"text\": {
                      \"tag\": \"lark_md\",
                      \"content\": \"**ğŸ“„ PR æ ‡é¢˜**: $PR_TITLE\\n**ğŸ‘¤ ä½œè€…**: @$PR_AUTHOR\\n\\n**âš ï¸ ä»¥ä¸‹æ–‡ä»¶ç¿»è¯‘çŠ¶æ€å·²è¶…æœŸï¼Œè¯·åŠæ—¶å¤„ç†**\"
                    }
                  }"

                while IFS= read -r line; do
                  json_part=${line#* }
                  # âœ… ä½¿ç”¨ ["å­—æ®µ"] è¯­æ³•è¯»å–ä¸­æ–‡å­—æ®µ
                  FILE=$(echo "$json_part" | jq -r '.["æ–‡ä»¶"]')
                  OVERDUE=$(echo "$json_part" | jq -r '.["è¶…æœŸ"]')
                  PR_LINK=$(echo "$json_part" | jq -r '.["PRé“¾æ¥"]')
                  AUTHOR=$(echo "$json_part" | jq -r '.["ä½œè€…"]')

                  # æ„é€ ä¸€ä¸ª div å…ƒç´ 
                  ELEMENTS="$ELEMENTS,
                  {
                    \"tag\": \"div\",
                    \"text\": {
                      \"tag\": \"lark_md\",
                      \"content\": \"æ–‡ä»¶: $FILE\\nè¶…æœŸ: $OVERDUE\\nPRé“¾æ¥: [ğŸ”— æŸ¥çœ‹è¯¦æƒ…]($PR_LINK)\\nä½œè€…: $AUTHOR\"
                    }
                  }"
                done < <(sort -k1,1 "$SORT_FILE")

                ELEMENTS="$ELEMENTS
                ]"
              else
                ELEMENTS="[
                  {
                    \"tag\": \"div\",
                    \"text\": {
                      \"tag\": \"lark_md\",
                      \"content\": \"æ— æ•°æ®\"
                    }
                  }
                ]"
              fi

              # ğŸ¨ æ„é€ å®Œæ•´å¡ç‰‡ JSON
              CARD_JSON=$(jq -n \
                --arg title "ğŸš¨ ç¿»è¯‘è¶…æœŸæé†’ [PR #$pr_number]" \
                --arg color "red" \
                --argjson elements "$ELEMENTS" \
                '{
                  "config": {"wide_screen_mode": true},
                  "header": {
                    "template": $color,
                    "title": {"content": $title, "tag": "plain_text"}
                  },
                  "elements": $elements
                }')

              # ğŸ“¤ ç”¨ curl å‘é€
              echo "ğŸ“¤ æ­£åœ¨å‘é€é£ä¹¦å¡ç‰‡..."
              RESPONSE=$(curl -s -X POST \
                -H "Content-Type: application/json" \
                -d "{\"msg_type\": \"interactive\", \"card\": $CARD_JSON}" \
                "$FEISHU_WEBHOOK_URL")

              # ğŸ§ª æ£€æŸ¥å“åº”
              if echo "$RESPONSE" | jq -e '.code == 0' >/dev/null 2>&1; then
                echo "âœ… é£ä¹¦é€šçŸ¥å·²å‘é€ã€‚"
              else
                echo "âŒ å‘é€å¤±è´¥: $RESPONSE"
              fi
            else
              echo "ğŸ‰ æ­¤ PR æ‰€æœ‰ Markdown æ–‡ä»¶å…ƒæ•°æ®ç¬¦åˆè§„èŒƒï¼"
            fi

            echo "------------------------------"
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}