# =============================================
# ğŸ“… å·¥ä½œæµåç§°ï¼šæ£€æŸ¥ä¸Šæ¸¸å·²ç¿»è¯‘çš„å†…æ ¸æ–‡æ¡£
# âœ… æ¯å¤© UTC 02:00 è‡ªåŠ¨æ‰«æ + æ”¯æŒæ‰‹åŠ¨è§¦å‘
# âœ… æ£€æŸ¥ sources/kernel/**/*.md ä¸­ status: collected æˆ– status: translating çš„æ–‡æ¡£
# âœ… å¯¹æ¯”ä¸Šæ¸¸æ˜¯å¦å·²å­˜åœ¨ä¸­æ–‡ç¿»è¯‘ç‰ˆæœ¬
# âœ… é€šè¿‡é£ä¹¦é€šçŸ¥ç®¡ç†å‘˜æ£€æŸ¥ç»“æœ
# =============================================

name: Check Upstream Kernel Translations

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤© UTC 02:00
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: read

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    steps:

      # ğŸ§± æ­¥éª¤ 1ï¼šæ£€å‡ºä»£ç 
      - name: ğŸ” Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ğŸ“¦ æ­¥éª¤ 2ï¼šå®‰è£… yqï¼ˆç”¨äºè§£æ YAMLï¼‰
      - name: ğŸ“¦ Install yq
        run: |
          wget -q https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      # âœ… æ­¥éª¤ 3ï¼šéªŒè¯ yq
      - name: âœ… Verify yq
        run: yq --version

      # ğŸ” æ­¥éª¤ 4ï¼šæ£€æŸ¥ä¸Šæ¸¸ç¿»è¯‘
      - name: ğŸ” Check upstream translations
        id: check_translations
        run: |
          set -e  # é‡åˆ°é”™è¯¯æ—¶é€€å‡º
          echo "ğŸš€ å¼€å§‹æ£€æŸ¥ä¸Šæ¸¸ç¿»è¯‘..."
          
          # æ£€æŸ¥sources/kernelç›®å½•æ˜¯å¦å­˜åœ¨
          if [ ! -d "sources/kernel" ]; then
            echo "âŒ sources/kernel ç›®å½•ä¸å­˜åœ¨"
            ls -la sources/ || echo "sources ç›®å½•ä¹Ÿä¸å­˜åœ¨"
            exit 1
          fi
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•å’Œæ–‡ä»¶
          TEMP_DIR=$(mktemp -d)
          trap 'rm -rf "$TEMP_DIR"' EXIT
          
          # å­˜å‚¨å‘ç°çš„å·²ç¿»è¯‘æ–‡æ¡£
          FOUND_TRANSLATIONS="found_translations.txt"
          touch "$FOUND_TRANSLATIONS"
          
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶æ¥è®°å½•ç»Ÿè®¡ä¿¡æ¯
          STATS_FILE="stats.txt"
          echo "0" > "$STATS_FILE"
          
          # è·å–æ‰€æœ‰ kernel ç›®å½•ä¸‹çš„ .md æ–‡ä»¶
          find sources/kernel -name "*.md" -type f > files_list.txt
          FILE_COUNT=$(wc -l < files_list.txt)
          echo "ğŸ“‹ æ‰¾åˆ° $FILE_COUNT ä¸ª .md æ–‡ä»¶ï¼Œå¼€å§‹æ£€æŸ¥..."
          
          # éå†æ‰€æœ‰æ–‡ä»¶
          PROCESSED_COUNT=0
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            PROCESSED_COUNT=$((PROCESSED_COUNT + 1))
            
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨å’Œå¯è¯»
            if [ ! -f "$file" ] || [ ! -r "$file" ]; then
              continue
            fi
            
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰YAMLå‰ç½®æ•°æ®
            if ! head -1 "$file" | grep -q "^---"; then
              continue
            fi
            
            # è§£æYAML front matter
            set +e
            YAML_CONTENT=$(awk '/^---$/{if(NR==1) next; if(NR>1) exit} NR>1' "$file")
            
            if [ -z "$YAML_CONTENT" ]; then
              STATUS=""
              LINK=""
              TITLE=""
              UPSTREAM_TRANSLATED=""
            else
              # ä½¿ç”¨ yq è§£ææå–çš„YAMLå†…å®¹
              STATUS=$(echo "$YAML_CONTENT" | yq eval '.status // ""' - 2>/dev/null || echo "")
              LINK=$(echo "$YAML_CONTENT" | yq eval '.link // ""' - 2>/dev/null || echo "")
              TITLE=$(echo "$YAML_CONTENT" | yq eval '.title // ""' - 2>/dev/null || echo "")
              UPSTREAM_TRANSLATED=$(echo "$YAML_CONTENT" | yq eval '.upstream_translated // ""' - 2>/dev/null || echo "")
              
              # å¦‚æœ yq è§£æå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•
              if [ -z "$STATUS" ] && [ -z "$LINK" ]; then
                STATUS=$(echo "$YAML_CONTENT" | grep '^status:' | sed 's/^status: *"\?\([^"]*\)"\?$/\1/' || echo "")
                LINK=$(echo "$YAML_CONTENT" | grep '^link:' | sed 's/^link: *"\?\([^"]*\)"\?$/\1/' || echo "")
                TITLE=$(echo "$YAML_CONTENT" | grep '^title:' | sed 's/^title: *"\?\([^"]*\)"\?$/\1/' || echo "")
                UPSTREAM_TRANSLATED=$(echo "$YAML_CONTENT" | grep '^upstream_translated:' | sed 's/^upstream_translated: *"\?\([^"]*\)"\?$/\1/' || echo "")
              fi
            fi
            set -e
            
            # å¦‚æœæ— æ³•è¯»å–ä»»ä½•å­—æ®µï¼Œè·³è¿‡
            if [ -z "$STATUS" ] && [ -z "$LINK" ]; then
              continue
            fi
            
            # åªæ£€æŸ¥ status: collected æˆ– status: translating
            if [ "$STATUS" != "collected" ] && [ "$STATUS" != "translating" ]; then
              continue
            fi
            
            # è·³è¿‡å·²æ ‡è®°çš„æ–‡æ¡£
            if [ "$UPSTREAM_TRANSLATED" = "true" ]; then
              continue
            fi
            
            if [ -z "$LINK" ]; then
              continue
            fi
            
            # æ›´æ–°ç»Ÿè®¡
            CURRENT_COUNT=$(cat "$STATS_FILE")
            TOTAL_CHECKED=$((CURRENT_COUNT + 1))
            echo "$TOTAL_CHECKED" > "$STATS_FILE"
            
            echo "ğŸ“„ æ£€æŸ¥æ–‡ä»¶ [$TOTAL_CHECKED]: $file (çŠ¶æ€: $STATUS)"
            
            # ä» link æå–æ–‡æ¡£è·¯å¾„
            DOC_PATH=$(echo "$LINK" | sed -n 's|.*tree/\(Documentation/.*\)|\1|p')
            
            if [ -z "$DOC_PATH" ]; then
              continue
            fi
            
            # æ„é€ ä¸­æ–‡ç¿»è¯‘è·¯å¾„
            DOC_RELATIVE=$(echo "$DOC_PATH" | sed 's|^Documentation/||')
            ZH_CN_PATH="Documentation/translations/zh_CN/${DOC_RELATIVE}"
            ZH_CN_URL="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/${ZH_CN_PATH}"
            
            # æ£€æŸ¥ä¸Šæ¸¸æ˜¯å¦å­˜åœ¨ä¸­æ–‡ç¿»è¯‘
            set +e
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -L --max-time 10 "$ZH_CN_URL" 2>/dev/null || echo "000")
            set -e
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "   âœ… å‘ç°ä¸Šæ¸¸ç¿»è¯‘ï¼"
              echo "$file|$TITLE|$STATUS|$LINK|$ZH_CN_URL" >> "$FOUND_TRANSLATIONS"
            fi
            
            # é¿å…è¯·æ±‚è¿‡å¿«
            sleep 0.5
          done < files_list.txt
          
          # è¯»å–æœ€ç»ˆç»Ÿè®¡
          TOTAL_CHECKED=$(cat "$STATS_FILE")
          FOUND_COUNT=$(wc -l < "$FOUND_TRANSLATIONS" 2>/dev/null || echo "0")
          
          # æ˜¾ç¤ºæ‰¾åˆ°çš„ç¿»è¯‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
          if [ "$FOUND_COUNT" -gt 0 ]; then
            echo ""
            echo "ğŸ“‹ å‘ç°çš„ä¸Šæ¸¸ç¿»è¯‘åˆ—è¡¨:"
            cat "$FOUND_TRANSLATIONS" | nl
          fi
          
          echo ""
          echo "========================================="
          echo "ğŸ“Š æ£€æŸ¥å®Œæˆï¼š"
          echo "æ€»å…±å¤„ç†æ–‡ä»¶: $PROCESSED_COUNT ä¸ª"
          echo "ç¬¦åˆæ¡ä»¶å¹¶æ£€æŸ¥: $TOTAL_CHECKED ä¸ªæ–‡æ¡£"
          echo "å‘ç°ä¸Šæ¸¸ç¿»è¯‘: $FOUND_COUNT ä¸ª"
          echo "========================================="
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f files_list.txt "$STATS_FILE"
          
          # è®¾ç½®è¾“å‡º
          echo "total_checked=$TOTAL_CHECKED" >> $GITHUB_OUTPUT
          echo "found_count=$FOUND_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$FOUND_COUNT" -gt 0 ]; then
            echo "has_translations=true" >> $GITHUB_OUTPUT
          else
            echo "has_translations=false" >> $GITHUB_OUTPUT
          fi

      # ğŸš¨ æ­¥éª¤ 5ï¼šå‘é€é£ä¹¦é€šçŸ¥
      - name: ğŸš¨ Send Feishu notification
        run: |
          # æ£€æŸ¥æ˜¯å¦é…ç½®äº†é£ä¹¦ Webhook
          if [ -z "$FEISHU_WEBHOOK_URL" ]; then
            echo "âš ï¸ æœªé…ç½® FEISHU_WEBHOOK_URLï¼Œè·³è¿‡é£ä¹¦é€šçŸ¥"
            echo "ğŸ’¡ å¦‚éœ€å¯ç”¨é£ä¹¦é€šçŸ¥ï¼Œè¯·åœ¨ GitHub Secrets ä¸­é…ç½® FEISHU_WEBHOOK_URL"
            exit 0
          fi
          
          TOTAL_CHECKED="${{ steps.check_translations.outputs.total_checked }}"
          FOUND_COUNT="${{ steps.check_translations.outputs.found_count }}"
          HAS_TRANSLATIONS="${{ steps.check_translations.outputs.has_translations }}"
          
          # æ£€æŸ¥æ˜¯å¦å‘ç°ç¿»è¯‘
          if [ "$HAS_TRANSLATIONS" = "true" ] && [ -f found_translations.txt ] && [ -s found_translations.txt ]; then
            # å‘ç°äº†ä¸Šæ¸¸ç¿»è¯‘
            echo "ğŸ‰ å‘ç° $FOUND_COUNT ä¸ªä¸Šæ¸¸å·²ç¿»è¯‘çš„æ–‡æ¡£ï¼Œå‘é€è­¦å‘Šé€šçŸ¥"
            
            # æ„é€ å¡ç‰‡ elements - å‚è€ƒ check-pr-md-files.yml çš„æ ¼å¼
            ELEMENTS="[
              {
                \"tag\": \"div\",
                \"text\": {
                  \"tag\": \"lark_md\",
                  \"content\": \"**âš ï¸ å‘ç°ä¸Šæ¸¸å·²ç¿»è¯‘çš„å†…æ ¸æ–‡æ¡£**\\n\\næœ¬æ¬¡æ£€æŸ¥äº† $TOTAL_CHECKED ä¸ªå¾…ç¿»è¯‘æ–‡æ¡£ï¼Œå‘ç° $FOUND_COUNT ä¸ªåœ¨ Linux å†…æ ¸ä¸Šæ¸¸å·²å­˜åœ¨ä¸­æ–‡ç¿»è¯‘ï¼Œå»ºè®®åœæ­¢é‡å¤ç¿»è¯‘å·¥ä½œï¼š\"
                }
              }"

            # ä¸ºæ¯ä¸ªå‘ç°çš„ç¿»è¯‘æ·»åŠ å¡ç‰‡å…ƒç´ 
            while IFS='|' read -r file title status link zh_cn_url; do
              # è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
              SAFE_FILE=$(echo "$file" | sed 's/"/\\"/g')
              SAFE_TITLE=$(echo "$title" | sed 's/"/\\"/g')
              SAFE_LINK=$(echo "$link" | sed 's/"/\\"/g')
              SAFE_ZH_URL=$(echo "$zh_cn_url" | sed 's/"/\\"/g')
              
              # æ„é€ ä¸€ä¸ª div å…ƒç´ 
              ELEMENTS="$ELEMENTS,
              {
                \"tag\": \"div\",
                \"text\": {
                  \"tag\": \"lark_md\",
                  \"content\": \"ğŸ“„ **æ–‡ä»¶**: \`$SAFE_FILE\`\\nğŸ“Œ **æ ‡é¢˜**: $SAFE_TITLE\\nğŸ”– **çŠ¶æ€**: $status\\nğŸ”— **åŸæ–‡**: $SAFE_LINK\\nğŸ‡¨ğŸ‡³ **ä¸Šæ¸¸ä¸­æ–‡**: $SAFE_ZH_URL\"
                }
              }"
            done < found_translations.txt

            ELEMENTS="$ELEMENTS
            ]"
            
            # æ„é€ å®Œæ•´å¡ç‰‡ JSON
            CARD_JSON=$(jq -n \
              --arg title "âš ï¸ å‘ç°ä¸Šæ¸¸å·²ç¿»è¯‘çš„å†…æ ¸æ–‡æ¡£" \
              --arg color "orange" \
              --argjson elements "$ELEMENTS" \
              '{
                "config": {"wide_screen_mode": true},
                "header": {
                  "template": $color,
                  "title": {"content": $title, "tag": "plain_text"}
                },
                "elements": $elements
              }')
          else
            # æœªå‘ç°ä¸Šæ¸¸ç¿»è¯‘
            echo "âœ… æœªå‘ç°ä¸Šæ¸¸å·²ç¿»è¯‘çš„æ–‡æ¡£ï¼Œå‘é€å®Œæˆé€šçŸ¥"
            
            # æ„é€ å®Œæ•´å¡ç‰‡ JSON - å‚è€ƒ check-pr-md-files.yml çš„æ ¼å¼
            CARD_JSON=$(jq -n \
              --arg title "âœ… ä¸Šæ¸¸ç¿»è¯‘æ£€æŸ¥å®Œæˆ" \
              --arg color "green" \
              --arg total "$TOTAL_CHECKED" \
              --arg time "$(date '+%Y-%m-%d %H:%M:%S UTC')" \
              '{
                "config": {"wide_screen_mode": true},
                "header": {
                  "template": $color,
                  "title": {"content": $title, "tag": "plain_text"}
                },
                "elements": [
                  {
                    "tag": "div",
                    "text": {
                      "tag": "lark_md",
                      "content": ("**âœ… æ£€æŸ¥å®Œæˆ**\\n\\næœ¬æ¬¡æ£€æŸ¥äº† " + $total + " ä¸ªå¾…ç¿»è¯‘æ–‡æ¡£ï¼ˆstatus: collected æˆ– translatingï¼‰ï¼Œæœªå‘ç°ä¸Šæ¸¸å·²ç¿»è¯‘çš„å†…æ ¸æ–‡æ¡£ã€‚\\n\\næ‰€æœ‰å¾…ç¿»è¯‘æ–‡æ¡£åœ¨ä¸Šæ¸¸éƒ½æ²¡æœ‰ä¸­æ–‡ç‰ˆæœ¬ï¼Œå¯ä»¥ç»§ç»­ç¿»è¯‘å·¥ä½œã€‚\\n\\n**æ£€æŸ¥æ—¶é—´**: " + $time)
                    }
                  }
                ]
              }')
          fi
          
          # å‘é€é£ä¹¦é€šçŸ¥
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"msg_type\": \"interactive\", \"card\": $CARD_JSON}" \
            "$FEISHU_WEBHOOK_URL")
          
          # æ£€æŸ¥å“åº”
          if echo "$RESPONSE" | jq -e '.code == 0' >/dev/null 2>&1; then
            echo "âœ… é£ä¹¦é€šçŸ¥å‘é€æˆåŠŸ"
          else
            echo "âŒ é£ä¹¦é€šçŸ¥å‘é€å¤±è´¥: $RESPONSE"
          fi
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL || '' }}
